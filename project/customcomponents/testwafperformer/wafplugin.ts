var WAFMIDIPresetURLs: { name: string, volume: number, octaveShift: number }[] = [];
WAFMIDIPresetURLs[1] = { name: "0000_JCLive_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[2] = { name: "0010_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[3] = { name: "0020_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[4] = { name: "0030_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[5] = { name: "0040_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[6] = { name: "0050_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[7] = { name: "0060_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[8] = { name: "0070_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[9] = { name: "0080_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[10] = { name: "0090_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[11] = { name: "0100_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[12] = { name: "0110_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[13] = { name: "0120_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[14] = { name: "0130_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[15] = { name: "0140_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[16] = { name: "0150_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[17] = { name: "0160_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[18] = { name: "0170_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[19] = { name: "0180_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[20] = { name: "0190_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[21] = { name: "0200_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[22] = { name: "0210_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[23] = { name: "0220_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[24] = { name: "0230_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[25] = { name: "0240_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[26] = { name: "0253_Acoustic_Guitar_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[27] = { name: "0260_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[28] = { name: "0270_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[29] = { name: "0280_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[30] = { name: "0290_Chaos_sf2_file", volume: 0.21, octaveShift: 0 };//{ name: "0290_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[31] = { name: "0300_LesPaul_sf2", volume: 0.72, octaveShift: 0 };
WAFMIDIPresetURLs[32] = { name: "0310_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[33] = { name: "0320_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[34] = { name: "0330_FluidR3_GM_sf2_file", volume: 0.41, octaveShift: 0 };
WAFMIDIPresetURLs[35] = { name: "0340_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[36] = { name: "0350_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[37] = { name: "0360_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[38] = { name: "0370_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[39] = { name: "0385_GeneralUserGS_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[40] = { name: "0390_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[41] = { name: "0400_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[42] = { name: "0410_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[43] = { name: "0420_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[44] = { name: "0430_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[45] = { name: "0440_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[46] = { name: "0450_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[47] = { name: "0460_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[48] = { name: "0470_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[49] = { name: "0480_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[50] = { name: "0490_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[51] = { name: "0500_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[52] = { name: "0510_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[53] = { name: "0520_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[54] = { name: "0530_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[55] = { name: "0540_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[56] = { name: "0550_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[57] = { name: "0560_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[58] = { name: "0570_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[59] = { name: "0580_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[60] = { name: "0590_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[61] = { name: "0600_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[62] = { name: "0610_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[63] = { name: "0620_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[64] = { name: "0630_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[65] = { name: "0640_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[66] = { name: "0650_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[67] = { name: "0660_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[68] = { name: "0670_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[69] = { name: "0680_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[70] = { name: "0690_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[71] = { name: "0700_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[72] = { name: "0710_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[73] = { name: "0720_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[74] = { name: "0730_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[75] = { name: "0740_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[76] = { name: "0750_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[77] = { name: "0760_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[78] = { name: "0770_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[79] = { name: "0780_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[80] = { name: "0790_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[81] = { name: "0800_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[82] = { name: "0810_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[83] = { name: "0820_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[84] = { name: "0830_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[85] = { name: "0840_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[86] = { name: "0850_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[87] = { name: "0860_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[88] = { name: "0870_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[89] = { name: "0880_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[90] = { name: "0890_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[91] = { name: "0900_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[92] = { name: "0910_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[93] = { name: "0920_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[94] = { name: "0930_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[95] = { name: "0940_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[96] = { name: "0950_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[97] = { name: "0960_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[98] = { name: "0970_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[99] = { name: "0980_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[100] = { name: "0990_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[101] = { name: "1000_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[102] = { name: "1010_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[103] = { name: "1020_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[104] = { name: "1030_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[105] = { name: "1040_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[106] = { name: "1050_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[107] = { name: "1060_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[108] = { name: "1070_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[109] = { name: "1080_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[110] = { name: "1090_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[111] = { name: "1100_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[112] = { name: "1110_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[113] = { name: "1120_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[114] = { name: "1130_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[115] = { name: "1140_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[116] = { name: "1150_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[117] = { name: "1160_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[118] = { name: "1170_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[119] = { name: "1180_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[120] = { name: "1190_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[121] = { name: "1200_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[122] = { name: "1210_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[123] = { name: "1220_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[124] = { name: "1230_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[125] = { name: "1240_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[126] = { name: "1250_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[127] = { name: "1260_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };
WAFMIDIPresetURLs[128] = { name: "1270_Aspirin_sf2_file", volume: 0.21, octaveShift: 0 };

type PresetInstrument = {
	variable: string
	, url: string
	, octaveShift: number
};
type WaveZone = {
	keyRangeLow: number
	, keyRangeHigh: number
	, originalPitch: number
	, coarseTune: number
	, fineTune: number
	, loopStart: number
	, loopEnd: number
	, buffer?: AudioBuffer
	, sampleRate: number
	, delay?: number
	, ahdsr?: boolean | WaveAHDSR[]
	, sample?: string
	, file?: string
	, sustain?: number
};
type WavePreset = {
	zones: WaveZone[];
	volume: number;
};
type WaveAHDSR = {
	duration: number
	, volume: number
};
type WaveEnvelope = {
	audioBufferSourceNode?: AudioBufferSourceNode | null
	, out: AudioNode
	, when: number
	, duration: number
	, cancel: () => void
	, pitch: number
	, preset: WavePreset
};

class PerformerPluginWAF implements MZXBX_AudioPerformerPlugin {
	out: GainNode;
	midiProgram: number = -1;
	instrumentKeyArray: string[] = [];
	instrumentNamesArray: string[] = [];
	envelopes: WaveEnvelope[] = [];
	afterTime = 0.05;
	nearZero = 0.000001;
	audioContext: AudioContext;
	launch(context: AudioContext, parameters: string): void {
		if (this.out) {
			//
		} else {
			this.audioContext = context;
			this.out = this.audioContext.createGain();
		}
		let nn: number = parseInt(parameters);
		if (this.midiProgram == nn) {
			//
		} else {
			this.midiProgram = nn;
			this.startLoadPreset(this.midiProgram);
		}
	}
	schedule(when: number, pitch: number, slides: MZXBX_SlideItem[]): void {
		let info: PresetInstrument = this.instrumentInfo(this.midiProgram);
		let preset: WavePreset = window[info.variable] as WavePreset;
		let rr = this.queueWaveTable(this.out, preset, when, pitch + info.octaveShift*12, slides);
		//if(info.octaveShift)console.log(rr,pitch,info.octaveShift);
	}
	output(): AudioNode | null {
		return this.out;
	}
	cancel(): void {
		this.cancelQueue();
	}
	busy(): string | null {
		if (this.presetReady(this.midiProgram)) {
			return null;
		} else {
			return 'program ' + this.midiProgram + ' isn\'t ready';
		}
	}
	startLoadPreset(nn: number) {
		let info: PresetInstrument = this.instrumentInfo(nn);
		let me = this;
		if (MZXBX_appendScriptURL(info.url)) {
			MZXBX_waitForCondition(250, () => { return (window[info.variable]); }, () => {
				let preset: WavePreset = window[info.variable] as WavePreset;
				preset.volume = 0.0;
				if (WAFMIDIPresetURLs[nn]) {
					preset.volume = WAFMIDIPresetURLs[nn].volume;
				}
				me.adjustPreset(preset);
			});
		}
	}
	presetReady(nn: number): boolean {
		let info: PresetInstrument = this.instrumentInfo(nn);
		let loaded = window[info.variable];
		if (loaded) {
			let preset: WavePreset = loaded as WavePreset;
			for (var i = 0; i < preset.zones.length; i++) {
				if (preset.zones[i].buffer) {
					//
				} else {
					return false;
				}
			}
			return true;
		} else {
			return false;
		}
	}
	adjustPreset(preset: WavePreset) {
		for (var i = 0; i < preset.zones.length; i++) {
			this.adjustZone(preset.zones[i]);
		}
	};
	adjustZone(zone: WaveZone) {
		if (zone.buffer) {
			//
		} else {
			zone.delay = 0;
			if (zone.sample) {
				var decoded = atob(zone.sample);
				zone.buffer = this.audioContext.createBuffer(1, decoded.length / 2, zone.sampleRate);
				var float32Array = zone.buffer.getChannelData(0);
				var b1,
					b2,
					n;
				for (var i = 0; i < decoded.length / 2; i++) {
					b1 = decoded.charCodeAt(i * 2);
					b2 = decoded.charCodeAt(i * 2 + 1);
					if (b1 < 0) {
						b1 = 256 + b1;
					}
					if (b2 < 0) {
						b2 = 256 + b2;
					}
					n = b2 * 256 + b1;
					if (n >= 65536 / 2) {
						n = n - 65536;
					}
					float32Array[i] = n / 65536.0;
				}
			} else {
				if (zone.file) {
					var datalen = zone.file.length;
					var arraybuffer = new ArrayBuffer(datalen);
					var view = new Uint8Array(arraybuffer);
					var decoded = atob(zone.file);
					var b;
					for (var i = 0; i < decoded.length; i++) {
						b = decoded.charCodeAt(i);
						view[i] = b;
					}
					this.audioContext.decodeAudioData(arraybuffer, function (audioBuffer) {
						zone.buffer = audioBuffer;
					});
				}
			}
			zone.loopStart = this.numValue(zone.loopStart, 0);
			zone.loopEnd = this.numValue(zone.loopEnd, 0);
			zone.coarseTune = this.numValue(zone.coarseTune, 0);
			zone.fineTune = this.numValue(zone.fineTune, 0);
			zone.originalPitch = this.numValue(zone.originalPitch, 6000);
			zone.sampleRate = this.numValue(zone.sampleRate, 44100);
			zone.sustain = this.numValue(zone.originalPitch, 0);
		}
	};
	numValue(aValue: any, defValue: number): number {
		if (typeof aValue === "number") {
			return aValue;
		} else {
			return defValue;
		}
	};
	findZone(audioContext: AudioContext, preset: WavePreset, pitch: number): WaveZone | null {
		var zone: WaveZone | null = null;
		for (var i = preset.zones.length - 1; i >= 0; i--) {
			zone = preset.zones[i];
			if (zone.keyRangeLow <= pitch && zone.keyRangeHigh + 1 >= pitch) {
				break;
			}
		}
		return zone;
	};
	findEnvelope(audioContext: AudioContext, out: AudioNode): WaveEnvelope {
		var envelope: WaveEnvelope | null = null;
		for (var i = 0; i < this.envelopes.length; i++) {
			var e = this.envelopes[i];
			if (e.out == out && audioContext.currentTime > e.when + e.duration + 0.001) {
				try {
					if (e.audioBufferSourceNode) {
						e.audioBufferSourceNode.disconnect();
						e.audioBufferSourceNode.stop(0);
						e.audioBufferSourceNode = null;
					}
				} catch (x) {
					//audioBufferSourceNode is dead already
				}
				envelope = e;
				break;
			}
		}
		if (!(envelope)) {
			envelope = (audioContext.createGain() as any) as WaveEnvelope;
			envelope.out = out;
			((envelope as any) as GainNode).connect(out);
			envelope.cancel = function () {
				if (envelope && (envelope.when + envelope.duration > audioContext.currentTime)) {
					((envelope as any) as GainNode).gain.cancelScheduledValues(0);
					((envelope as any) as GainNode).gain.setTargetAtTime(0.00001, audioContext.currentTime, 0.1);
					envelope.when = audioContext.currentTime + 0.00001;
					envelope.duration = 0;
				}
			};
			this.envelopes.push(envelope);
		}
		return envelope;
	};
	setupEnvelope(audioContext: AudioContext, envelope: WaveEnvelope, zone: WaveZone, volume: number, when: number, sampleDuration: number, noteDuration: number) {
		((envelope as any) as GainNode).gain.setValueAtTime(this.noZeroVolume(0), audioContext.currentTime);
		var lastTime = 0;
		var lastVolume = 0;
		var duration = noteDuration;
		var zoneahdsr: undefined | boolean | WaveAHDSR[] = zone.ahdsr;
		if (sampleDuration < duration + this.afterTime) {
			duration = sampleDuration - this.afterTime;
		}
		if (zoneahdsr) {
			if (!((zoneahdsr as any).length > 0)) {
				zoneahdsr = [{
					duration: 0,
					volume: 1
				}, {
					duration: 0.5,
					volume: 1
				}, {
					duration: 1.5,
					volume: 0.5
				}, {
					duration: 3,
					volume: 0
				}
				];
			}
		} else {
			zoneahdsr = [{
				duration: 0,
				volume: 1
			}, {
				duration: duration,
				volume: 1
			}
			];
		}
		var ahdsr: WaveAHDSR[] = zoneahdsr as WaveAHDSR[];
		((envelope as any) as GainNode).gain.cancelScheduledValues(when);
		((envelope as any) as GainNode).gain.setValueAtTime(this.noZeroVolume(ahdsr[0].volume * volume), when);
		for (var i = 0; i < ahdsr.length; i++) {
			if (ahdsr[i].duration > 0) {
				if (ahdsr[i].duration + lastTime > duration) {
					var r = 1 - (ahdsr[i].duration + lastTime - duration) / ahdsr[i].duration;
					var n = lastVolume - r * (lastVolume - ahdsr[i].volume);
					((envelope as any) as GainNode).gain.linearRampToValueAtTime(this.noZeroVolume(volume * n), when + duration);
					break;
				}
				lastTime = lastTime + ahdsr[i].duration;
				lastVolume = ahdsr[i].volume;
				((envelope as any) as GainNode).gain.linearRampToValueAtTime(this.noZeroVolume(volume * lastVolume), when + lastTime);
			}
		}
		((envelope as any) as GainNode).gain.linearRampToValueAtTime(this.noZeroVolume(0), when + duration + this.afterTime);
	};
	noZeroVolume(n: number): number {
		if (n > this.nearZero) {
			return n;
		} else {
			return this.nearZero;
		}
	};
	queueWaveTable(out: AudioNode, preset: WavePreset, when: number, pitch: number, slides: MZXBX_SlideItem[]): WaveEnvelope | null {
		var zone: WaveZone | null = this.findZone(this.audioContext, preset, pitch);
		if (zone) {
			if (!(zone.buffer)) {
				console.log('empty buffer ', zone);
				return null;
			}
			var baseDetune = zone.originalPitch - 100.0 * zone.coarseTune - zone.fineTune;
			var playbackRate = 1.0 * Math.pow(2, (100.0 * pitch - baseDetune) / 1200.0);
			var startWhen = when;
			if (startWhen < this.audioContext.currentTime) {
				startWhen = this.audioContext.currentTime;
			}
			let noteDuration = 0;
			for (let i = 0; i < slides.length; i++) {
				noteDuration = noteDuration + slides[i].duration;
			}
			var waveDuration = noteDuration + this.afterTime;
			var loop = true;
			if (zone.loopStart < 1 || zone.loopStart >= zone.loopEnd) {
				loop = false;
			}
			if (!loop) {
				if (waveDuration > zone.buffer.duration / playbackRate) {
					waveDuration = zone.buffer.duration / playbackRate;
				}
			}
			var envelope: WaveEnvelope = this.findEnvelope(this.audioContext, out);
			this.setupEnvelope(this.audioContext, envelope, zone, preset.volume, startWhen, waveDuration, noteDuration);
			envelope.audioBufferSourceNode = this.audioContext.createBufferSource();
			envelope.audioBufferSourceNode.playbackRate.setValueAtTime(playbackRate, 0);
			var newWhen = startWhen;
			for (var ii = 0; ii < slides.length; ii++) {
				var nextPitch = pitch + slides[ii].delta;
				var newPlaybackRate = 1.0 * Math.pow(2, (100.0 * nextPitch - baseDetune) / 1200.0);
				var newWhen = newWhen + slides[ii].duration;
				envelope.audioBufferSourceNode.playbackRate.linearRampToValueAtTime(newPlaybackRate, newWhen);
			}
			envelope.audioBufferSourceNode.buffer = zone.buffer;
			if (loop) {
				envelope.audioBufferSourceNode.loop = true;
				envelope.audioBufferSourceNode.loopStart = zone.loopStart / zone.sampleRate + ((zone.delay) ? zone.delay : 0);
				envelope.audioBufferSourceNode.loopEnd = zone.loopEnd / zone.sampleRate + ((zone.delay) ? zone.delay : 0);
			} else {
				envelope.audioBufferSourceNode.loop = false;
			}
			envelope.audioBufferSourceNode.connect((envelope as any) as GainNode);
			envelope.audioBufferSourceNode.start(startWhen, zone.delay);
			envelope.audioBufferSourceNode.stop(startWhen + waveDuration);
			envelope.when = startWhen;
			envelope.duration = waveDuration;
			envelope.pitch = pitch;
			envelope.preset = preset;
			return envelope;
		} else {
			return null
		}
	};
	cancelQueue() {
		for (var i = 0; i < this.envelopes.length; i++) {
			var e = this.envelopes[i];
			((e as any) as GainNode).gain.cancelScheduledValues(0);
			((e as any) as GainNode).gain.setValueAtTime(this.nearZero, this.audioContext.currentTime);
			e.when = -1;
			try {
				if (e.audioBufferSourceNode) e.audioBufferSourceNode.disconnect();
			} catch (ex) {
				console.log(ex);
			}
		}
	}
	instrumentInfo(n: number): PresetInstrument {
		var key: string = '';
		if (WAFMIDIPresetURLs[n]) {
			key = WAFMIDIPresetURLs[n].name;
		}
		if (!(key)) {
			console.log('not found instrument definition for', n);
		}
		return {
			variable: '_tone_' + key,
			url: 'https://surikov.github.io/webaudiofontdata/sound/' + key + '.js'
			, octaveShift: WAFMIDIPresetURLs[n].octaveShift
		};
	};
}
function testPluginWAF(): MZXBX_AudioPerformerPlugin {
	return new PerformerPluginWAF();
}
